<script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, deleteDoc, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD5dFgt8ND020zkaR8VjlvPrYWcPtBkJJA",
            authDomain: "commst-c7bd2.firebaseapp.com",
            projectId: "commst-c7bd2",
            storageBucket: "commst-c7bd2.appspot.com",
            messagingSenderId: "606435543669",
            appId: "1:606435543669:web:6019e989a1d776f5a2c63c",
            measurementId: "G-RG8XNF865Q"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- App State ---
        let currentUser = null;
        let sales = [];
        let currentSaleServices = [];
        let userSettings = { name: '', theme: 'light', tempUnit: 'C' };
        let currentGoals = {
            weekly: { mobile: 0, internet: 0, tv: 0 },
            monthly: { mobile: 0, internet: 0, tv: 0 }
        };
        // DELETED: The hardcoded product catalog is gone.
        // NEW: This will be populated from Firestore.
        let productCatalog = {};

        // --- DOM Elements ---
        const loginModal = document.getElementById('login-modal');
        const signupModal = document.getElementById('signup-modal');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const loginErrorEl = document.getElementById('login-error');
        const signupErrorEl = document.getElementById('signup-error');
        const showSignupBtn = document.getElementById('show-signup');
        const showLoginBtn = document.getElementById('show-login');
        const logoutBtn = document.getElementById('logout-btn');
        const splashScreen = document.getElementById('splash-screen');
        const oobeGoalsScreen = document.getElementById('oobe-goals-screen');
        const oobeGoalsForm = document.getElementById('oobe-goals-form');
        const appContainer = document.getElementById('app-container');
        const welcomeMessageEl = document.getElementById('welcome-message');
        const salesListEl = document.getElementById('sales-list'), noSalesMessage = document.getElementById('no-sales-message');
        const addSaleBtnMain = document.getElementById('add-sale-btn-main');
        const addSaleBtnDesktop = document.getElementById('add-sale-btn-desktop');
        const saleModal = document.getElementById('sale-modal'), saleForm = document.getElementById('sale-form'), cancelBtn = document.getElementById('cancel-btn');
        const totalSalesEl = document.getElementById('total-sales'), totalCommissionEl = document.getElementById('total-commission'), avgCommissionEl = document.getElementById('avg-commission');
        const totalSalesMobileEl = document.getElementById('total-sales-mobile'), totalCommissionMobileEl = document.getElementById('total-commission-mobile'), avgCommissionMobileEl = document.getElementById('avg-commission-mobile');
        const goalsContainer = document.getElementById('goals-container'), editGoalsBtn = document.getElementById('edit-goals-btn');
        const filterProductEl = document.getElementById('filter-product'), sortSalesEl = document.getElementById('sort-sales');
        const categorySelect = document.getElementById('category'), serviceOptionsContainer = document.getElementById('service-options-container');
        const addServiceBtn = document.getElementById('add-service-btn'), currentSaleServicesEl = document.getElementById('current-sale-services');
        const totalCommissionDisplay = document.getElementById('total-commission-display'), noServicesAddedEl = document.getElementById('no-services-added');
        const timeDisplay = document.getElementById('time-display'), dateDisplay = document.getElementById('date-display'), weatherDisplay = document.getElementById('weather-display');
        const goalsModal = document.getElementById('goals-modal'), goalsForm = document.getElementById('goals-form'), cancelGoalsBtn = document.getElementById('cancel-goals-btn');
        const settingsBtn = document.getElementById('settings-btn'), settingsMenu = document.getElementById('settings-menu');
        const themeToggleBtn = document.getElementById('theme-toggle'), tempToggleBtn = document.getElementById('temp-toggle');

        // --- Firebase & Auth Logic ---
        
        // NEW: Function to fetch the product catalog from Firestore.
        async function fetchProductCatalog() {
            const docRef = doc(db, "app_config", "product_catalog");
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                productCatalog = docSnap.data();
                console.log("Successfully fetched product catalog.");
            } else {
                // This is a fatal error, the app cannot work without the catalog.
                throw new Error("Product Catalog could not be found in the database.");
            }
        }

        function showFatalError(error) {
            console.error("A fatal error occurred:", error);
            splashScreen.style.display = 'none';
            appContainer.style.display = 'block';
            const errorMessage = `
                <div class="text-center py-10 px-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm">
                    <h3 class="text-xl font-bold text-red-600 mb-2">Application Error</h3>
                    <p class="text-slate-500 dark:text-slate-400">
                        Could not load essential application configuration.
                    </p>
                    <p class="text-xs text-slate-400 dark:text-slate-500 mt-4">
                        Details: ${error.message}. Please contact support.
                    </p>
                </div>
            `;
            const mainContentArea = document.querySelector('#app-container main');
            if (mainContentArea) {
                mainContentArea.innerHTML = errorMessage;
            }
        }

        onAuthStateChanged(auth, async (user) => {
            splashScreen.style.display = 'flex';

            setTimeout(async () => {
                try {
                    if (user) {
                        currentUser = user;
                        loginModal.style.display = 'none';
                        signupModal.style.display = 'none';
                        
                        // UPDATED: Fetch catalog first, as it's essential for everything else.
                        await fetchProductCatalog();
                        await fetchData();
                        
                        splashScreen.style.display = 'none';

                        if (currentGoals.weekly.mobile === 0 && currentGoals.monthly.mobile === 0) {
                            oobeGoalsScreen.style.display = 'flex';
                        } else {
                            appContainer.style.display = 'block';
                            renderFullUI();
                        }
                    } else {
                        currentUser = null;
                        resetLocalData();
                        
                        splashScreen.style.display = 'none';
                        appContainer.style.display = 'none';
                        oobeGoalsScreen.style.display = 'none';
                        loginModal.style.display = 'flex';
                    }
                } catch (error) {
                    showFatalError(error);
                }
            }, 2000);
        });
        
        async function handleSignup(e) {
            e.preventDefault();
            const name = signupForm['signup-name'].value;
            const email = signupForm['signup-email'].value;
            const password = signupForm['signup-password'].value;
            signupErrorEl.textContent = '';
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: name });
            } catch (error) {
                signupErrorEl.textContent = error.message;
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            loginErrorEl.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                loginErrorEl.textContent = 'Invalid email or password.';
            }
        }

        async function handleLogout() {
            await signOut(auth);
            window.location.reload();
        }
        
        // --- Firestore Data Functions ---

        async function fetchData() {
            if (!currentUser) return;
            const uid = currentUser.uid;

            const settingsDocRef = doc(db, 'users', uid, 'user-data', 'settings');
            const settingsDocSnap = await getDoc(settingsDocRef);
            if (settingsDocSnap.exists()) {
                userSettings = settingsDocSnap.data();
            } else {
                userSettings = { name: currentUser.displayName, theme: 'light', tempUnit: 'C' };
            }
            applySettings();

            const goalsDocRef = doc(db, 'users', uid, 'user-data', 'goals');
            const goalsDocSnap = await getDoc(goalsDocRef);
            if (goalsDocSnap.exists()) {
                currentGoals = goalsDocSnap.data();
            } else {
                currentGoals = { weekly: { mobile: 0, internet: 0, tv: 0 }, monthly: { mobile: 0, internet: 0, tv: 0 } };
            }

            const salesCollectionRef = collection(db, 'users', uid, 'sales');
            const q = query(salesCollectionRef);
            const querySnapshot = await getDocs(q);
            sales = [];
            querySnapshot.forEach((doc) => {
                sales.push({ id: doc.id, ...doc.data() });
            });
        }
        
        async function saveSaleToFirestore(saleData) {
            if (!currentUser) return;
            const uid = currentUser.uid;
            try {
                const docRef = await addDoc(collection(db, 'users', uid, 'sales'), saleData);
                sales.push({ id: docRef.id, ...saleData });
                renderFullUI();
            } catch (error) {
                console.error("Error adding document: ", error);
                alert("Could not save sale. Please try again.");
            }
        }

        async function deleteSaleFromFirestore(saleId) {
            if (!currentUser) return;
            const uid = currentUser.uid;
            try {
                await deleteDoc(doc(db, 'users', uid, 'sales', saleId));
                sales = sales.filter(sale => sale.id !== saleId);
                renderFullUI();
            } catch (error) {
                console.error("Error deleting document: ", error);
                alert("Could not delete sale. Please try again.");
            }
        }
        
        async function saveGoalsToFirestore(newGoals) {
            if (!currentUser) return;
            const uid = currentUser.uid;
            try {
                const goalsDocRef = doc(db, 'users', uid, 'user-data', 'goals');
                await setDoc(goalsDocRef, newGoals, { merge: true });
                currentGoals = newGoals;
            } catch (error) {
                console.error("Error saving goals: ", error);
                alert("Could not save goals. Please try again.");
            }
        }

        async function saveSettingsToFirestore(newSettings) {
            if (!currentUser) return;
            const uid = currentUser.uid;
            try {
                const settingsDocRef = doc(db, 'users', uid, 'user-data', 'settings');
                await setDoc(settingsDocRef, newSettings, { merge: true });
                userSettings = { ...userSettings, ...newSettings };
                applySettings();
            } catch (error) {
                console.error("Error saving settings: ", error);
            }
        }
        
        function applySettings() {
            document.documentElement.classList.toggle('dark', userSettings.theme === 'dark');
            if (currentUser) {
                welcomeMessageEl.textContent = `Welcome, ${userSettings.name || currentUser.displayName}!`;
            }
            updateWeather();
        }

        function resetLocalData() {
            sales = [];
            userSettings = { name: '', theme: 'light', tempUnit: 'C' };
            currentGoals = { weekly: { mobile: 0, internet: 0, tv: 0 }, monthly: { mobile: 0, internet: 0, tv: 0 } };
            productCatalog = {}; // Also reset catalog on logout
        }
        
        // --- UI & Logic Functions ---
        const openModal = () => saleModal.classList.remove('hidden');
        const closeModal = () => { saleModal.classList.add('hidden'); saleForm.reset(); currentSaleServices=[]; renderCurrentServices(); updateServiceBuilderUI(); };
        const showGoalsModal = () => { 
            document.getElementById('goal-weekly-mobile').value = currentGoals.weekly.mobile || 0;
            document.getElementById('goal-weekly-internet').value = currentGoals.weekly.internet || 0;
            document.getElementById('goal-weekly-tv').value = currentGoals.weekly.tv || 0;
            document.getElementById('goal-monthly-mobile').value = currentGoals.monthly.mobile || 0;
            document.getElementById('goal-monthly-internet').value = currentGoals.monthly.internet || 0;
            document.getElementById('goal-monthly-tv').value = currentGoals.monthly.tv || 0;
            goalsModal.classList.remove('hidden');
        };
        const hideGoalsModal = () => goalsModal.classList.add('hidden');
        
        const renderFullUI = () => {
            renderGoals();
            updateDashboard();
            renderSales();
        };

        const renderGoals = () => {
            const { weeklyProgress, monthlyProgress } = calculateProgress();
            const goalData = [
                { title: 'This Week', progress: weeklyProgress, goals: currentGoals.weekly },
                { title: 'This Month', progress: monthlyProgress, goals: currentGoals.monthly }
            ];
            goalsContainer.innerHTML = '';
            goalData.forEach(period => {
                const periodEl = document.createElement('div');
                periodEl.innerHTML = `<h4 class="font-semibold text-lg mb-2">${period.title}</h4><div class="space-y-3"></div>`;
                const container = periodEl.querySelector('.space-y-3');
                ['Mobile', 'Internet', 'TV'].forEach(cat => {
                    const target = period.goals?.[cat.toLowerCase()] || 0;
                    const current = period.progress[cat];
                    const percentage = target > 0 ? (current / target) * 100 : 0;
                    const label = cat === 'Mobile' ? 'Lines' : 'Services';
                    const goalItem = document.createElement('div');
                    goalItem.innerHTML = `<div class="flex justify-between text-sm mb-1"><span class="font-medium">${cat} ${label}</span><span>${current} / ${target}</span></div><div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2"><div class="bg-att-blue h-2 rounded-full" style="width: ${Math.min(percentage, 100)}%"></div></div>`;
                    container.appendChild(goalItem);
                });
                goalsContainer.appendChild(periodEl);
            });
        };
        
        const updateDashboard = () => {
            const totalSalesCount = sales.length;
            const totalCommission = sales.reduce((sum, sale) => sum + sale.totalCommission, 0);
            const avgCommission = totalSalesCount > 0 ? totalCommission / totalSalesCount : 0;
            totalSalesEl.textContent = totalSalesCount;
            totalCommissionEl.textContent = `$${totalCommission.toFixed(2)}`;
            avgCommissionEl.textContent = `$${avgCommission.toFixed(2)}`;
            totalSalesMobileEl.textContent = totalSalesCount;
            totalCommissionMobileEl.textContent = `$${totalCommission.toFixed(0)}`;
            avgCommissionMobileEl.textContent = `$${avgCommission.toFixed(0)}`;
        };

        const renderSales = () => {
            salesListEl.innerHTML = '';
            const filteredSales = filterAndSortSales();
            noSalesMessage.style.display = filteredSales.length === 0 ? 'block' : 'none';
            filteredSales.forEach((sale) => {
                const saleEl = document.createElement('div');
                saleEl.className = 'flex flex-col md:flex-row items-start md:items-center justify-between py-4';
                saleEl.dataset.id = sale.id; 
                const mainCategory = sale.services[0]?.category || 'Misc';
                const color = { Mobile: { bg: 'bg-blue-100 dark:bg-blue-900/50' }, Internet: { bg: 'bg-green-100 dark:bg-green-900/50' }, DirecTV: { bg: 'bg-purple-100 dark:bg-purple-900/50' }}[mainCategory] || {bg:'bg-slate-100 dark:bg-slate-700'};
                const servicesHTML = sale.services.map(s => `<li class="text-sm text-slate-600 dark:text-slate-300 font-medium">${s.planName}${s.lines ? ` (${s.lines} lines)` : ''}</li>`).join('');
                saleEl.innerHTML = `<div class="flex items-center gap-4 flex-1"><div class="p-3 rounded-full ${color.bg}"></div><div><p class="font-semibold text-slate-800 dark:text-slate-100">${sale.customerName}</p><ul class="list-disc list-inside ml-4">${servicesHTML}</ul><p class="text-sm text-slate-500 dark:text-slate-400 mt-1">${new Date(sale.saleDate + 'T00:00:00').toLocaleDateString()}</p>${sale.notes ? `<p class="text-xs text-slate-400 mt-1 italic">Note: ${sale.notes}</p>` : ''}</div></div><div class="flex items-center gap-4 mt-3 md:mt-0 w-full md:w-auto"><span class="font-semibold text-emerald-600 text-lg">$${sale.totalCommission.toFixed(2)}</span><button class="delete-btn p-2 text-slate-500 hover:text-red-600 dark:hover:text-red-400"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg></button></div>`;
                salesListEl.appendChild(saleEl);
            });
        };
        
        const calculateProgress = () => {
             const weeklyProgress = { Mobile: 0, Internet: 0, TV: 0 };
             const monthlyProgress = { Mobile: 0, Internet: 0, TV: 0 };
             const startOfWeek = getStartOfWeek();
             const startOfMonth = getStartOfMonth();
             sales.forEach(sale => {
                 const saleDate = new Date(sale.saleDate + 'T00:00:00');
                 sale.services.forEach(service => {
                     const category = service.category === 'DirecTV' ? 'TV' : service.category;
                     const units = category === 'Mobile' ? (service.lines || 0) : 1;
                     if (monthlyProgress.hasOwnProperty(category)) {
                         if (saleDate >= startOfMonth) { monthlyProgress[category] += units; }
                         if (saleDate >= startOfWeek) { weeklyProgress[category] += units; }
                     }
                 });
             });
             return { weeklyProgress, monthlyProgress };
        };
        
        const filterAndSortSales = () => {
            const filterValue = filterProductEl.value;
            const sortValue = sortSalesEl.value;
            let processedSales = [...sales];
            if (filterValue !== 'all') { processedSales = processedSales.filter(sale => sale.services.some(s => s.category === filterValue)); }
            processedSales.sort((a, b) => {
                switch(sortValue) {
                    case 'date_asc': return new Date(a.saleDate) - new Date(b.saleDate);
                    case 'commission_desc': return b.totalCommission - a.totalCommission;
                    case 'commission_asc': return a.totalCommission - b.totalCommission;
                    default: return new Date(b.saleDate) - new Date(a.saleDate);
                }
            });
            return processedSales;
        };

        const updateServiceBuilderUI = () => {
            const category = categorySelect.value;
            serviceOptionsContainer.innerHTML = '';
            if (!category || !productCatalog[category]) return;
            const categoryData = productCatalog[category];
            let optionsHTML = `<div><label for="service-plan" class="block text-sm font-medium mb-1">2. Configure Service</label><select id="service-plan" class="w-full px-3 py-2 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-lg"><option value="">-- Select Plan --</option>`;
            Object.keys(categoryData.plans).forEach(planName => optionsHTML += `<option value="${planName}">${planName}</option>`);
            optionsHTML += `</select></div>`;
            if (category === 'Mobile') {
                optionsHTML += `<div id="lines-section" class="hidden"><label for="lines" class="block text-sm font-medium mb-1">Number of Lines</label><input type="number" id="lines" class="w-full px-3 py-2 bg-white dark:bg-slate-700 border rounded-lg" min="1" value="1"></div>`;
                optionsHTML += `<div><label class="block text-sm font-medium mb-2">Add-ons</label><div id="mobile-addons" class="space-y-2">`;
                Object.keys(categoryData.addOns).forEach(addonName => optionsHTML += `<div class="flex items-center"><input type="checkbox" id="addon-${addonName.replace(/\s+/g, '-')}" name="${addonName}" class="h-4 w-4 text-att-blue rounded"><label for="addon-${addonName.replace(/\s+/g, '-')}" class="ml-2">${addonName}</label></div>`);
                optionsHTML += `</div></div>`;
            }
            serviceOptionsContainer.innerHTML = optionsHTML;
            const planSelect = document.getElementById('service-plan');
            if (planSelect && category === 'Mobile') {
                planSelect.addEventListener('change', () => {
                    const plan = productCatalog.Mobile.plans[planSelect.value];
                    document.getElementById('lines-section').style.display = plan && plan.hasLines ? 'block' : 'none';
                });
            }
        };
        
        const renderCurrentServices = () => {
            currentSaleServicesEl.innerHTML = '';
            noServicesAddedEl.style.display = currentSaleServices.length === 0 ? 'block' : 'none';
            currentSaleServices.forEach((service, index) => {
                let title = `${service.planName}${service.lines ? ` (${service.lines} lines)` : ''}`;
                const serviceEl = document.createElement('div');
                serviceEl.className = 'bg-slate-100 dark:bg-slate-700/50 p-2 rounded-lg flex justify-between items-center';
                serviceEl.innerHTML = `<div><p class="font-semibold">${title}</p><p class="text-sm text-slate-500">${service.category}</p></div><div class="flex items-center gap-4"><span class="font-medium text-emerald-500">$${service.commission.toFixed(2)}</span><button type="button" data-index="${index}" class="remove-service-btn p-1 text-red-500 hover:text-red-700">&times;</button></div>`;
                currentSaleServicesEl.appendChild(serviceEl);
            });
            totalCommissionDisplay.textContent = `$${currentSaleServices.reduce((sum, s) => sum + s.commission, 0).toFixed(2)}`;
        };
        
        const addServiceToSale = () => {
            const category = categorySelect.value;
            const planSelect = document.getElementById('service-plan');
            if (!category || !planSelect || !planSelect.value) { return; }
            const planName = planSelect.value;
            const categoryData = productCatalog[category];
            const planData = categoryData.plans[planName];
            const service = { category, planName, commission: 0, addOns: [], lines: null };
            if (category === 'Mobile') {
                let perLineCommission = 0;
                const selectedAddons = Array.from(document.querySelectorAll('#mobile-addons input:checked')).map(cb => cb.name);
                const hasNextUp = selectedAddons.includes('AT&T Next Up');
                if (hasNextUp && planData.baseCommission > 0 && categoryData.addOns['AT&T Next Up'].combo[planName]) {
                    perLineCommission = categoryData.addOns['AT&T Next Up'].combo[planName];
                } else {
                    perLineCommission = planData.baseCommission;
                }
                selectedAddons.forEach(addonName => {
                    if (addonName === 'AT&T Next Up' && perLineCommission > planData.baseCommission) return;
                    perLineCommission += categoryData.addOns[addonName].commission;
                });
                service.addOns = selectedAddons;
                if (planData.hasLines) {
                    const numberOfLines = parseInt(document.getElementById('lines').value, 10) || 1;
                    service.commission = perLineCommission * numberOfLines;
                    service.lines = numberOfLines;
                } else {
                    service.commission = perLineCommission;
                }
            } else {
                service.commission = planData.baseCommission;
            }
            currentSaleServices.push(service);
            renderCurrentServices();
            planSelect.value = '';
            planSelect.dispatchEvent(new Event('change'));
            if (category === 'Mobile') {
                document.querySelectorAll('#mobile-addons input:checked').forEach(cb => cb.checked = false);
            }
        };

        const toggleTheme = () => saveSettingsToFirestore({ theme: userSettings.theme === 'light' ? 'dark' : 'light' });
        const toggleTempUnit = () => saveSettingsToFirestore({ tempUnit: userSettings.tempUnit === 'C' ? 'F' : 'C' });
        
        const updateTime = () => timeDisplay.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        const updateWeather = () => {
            dateDisplay.textContent = new Date().toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            fetch('https://api.open-meteo.com/v1/forecast?latitude=28.11&longitude=-81.62&current_weather=true&temperature_unit=fahrenheit')
                .then(res => res.json()).then(data => {
                    if (data && data.current_weather) {
                        const tempF = data.current_weather.temperature; 
                        const tempC = (tempF - 32) * 5/9;
                        const displayTemp = userSettings.tempUnit === 'F' ? tempF.toFixed(0) : tempC.toFixed(0);
                        const code = data.current_weather.weathercode;
                        let emoji = 'â˜€ï¸';
                        if (code > 70) emoji = 'ðŸŒ§ï¸'; else if (code > 50) emoji = 'ðŸŒ¦ï¸'; else if (code > 2) emoji = 'â˜ï¸';
                        weatherDisplay.textContent = `${displayTemp}Â°${userSettings.tempUnit} ${emoji} in Haines City, FL`;
                    } else { weatherDisplay.textContent = 'Weather unavailable'; }
                }).catch(() => weatherDisplay.textContent = 'Weather unavailable');
        };
        
        const getStartOfWeek = () => { const n=new Date(),d=n.getDay(),f=n.getDate()-d+(d==0?-6:1);return new Date(new Date(n.setDate(f)).setHours(0,0,0,0)); };
        const getStartOfMonth = () => { const n=new Date();return new Date(n.getFullYear(),n.getMonth(),1); };
        
        // --- Event Listeners ---
        function setupEventListeners() {
            // Auth Listeners
            loginForm.addEventListener('submit', handleLogin);
            signupForm.addEventListener('submit', handleSignup);
            logoutBtn.addEventListener('click', handleLogout);
            showSignupBtn.addEventListener('click', (e) => { e.preventDefault(); loginModal.style.display = 'none'; signupModal.style.display = 'flex'; });
            showLoginBtn.addEventListener('click', (e) => { e.preventDefault(); signupModal.style.display = 'none'; loginModal.style.display = 'flex'; });
            
            oobeGoalsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newGoals = { 
                    weekly: { mobile: parseInt(document.getElementById('oobe-goal-weekly-mobile').value) || 0, internet: parseInt(document.getElementById('oobe-goal-weekly-internet').value) || 0, tv: parseInt(document.getElementById('oobe-goal-weekly-tv').value) || 0 },
                    monthly: { mobile: parseInt(document.getElementById('oobe-goal-monthly-mobile').value) || 0, internet: parseInt(document.getElementById('oobe-goal-monthly-internet').value) || 0, tv: parseInt(document.getElementById('oobe-goal-monthly-tv').value) || 0 } 
                };
                await saveGoalsToFirestore(newGoals);
                oobeGoalsScreen.style.display = 'none';
                appContainer.style.display = 'block'; 
                renderFullUI();
            });

            // App Listeners
            addSaleBtnMain.addEventListener('click', openModal);
            addSaleBtnDesktop.addEventListener('click', openModal);
            cancelBtn.addEventListener('click', closeModal);
            editGoalsBtn.addEventListener('click', showGoalsModal);
            cancelGoalsBtn.addEventListener('click', hideGoalsModal);
            filterProductEl.addEventListener('change', renderFullUI);
            sortSalesEl.addEventListener('change', renderFullUI);
            categorySelect.addEventListener('change', updateServiceBuilderUI);
            goalsForm.addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                const newGoals = { weekly: { mobile: parseInt(document.getElementById('goal-weekly-mobile').value) || 0, internet: parseInt(document.getElementById('goal-weekly-internet').value) || 0, tv: parseInt(document.getElementById('goal-weekly-tv').value) || 0 }, monthly: { mobile: parseInt(document.getElementById('goal-monthly-mobile').value) || 0, internet: parseInt(document.getElementById('goal-monthly-internet').value) || 0, tv: parseInt(document.getElementById('goal-monthly-tv').value) || 0 } };
                await saveGoalsToFirestore(newGoals);
                renderFullUI();
                hideGoalsModal(); 
            });
            addServiceBtn.addEventListener('click', addServiceToSale);
            currentSaleServicesEl.addEventListener('click', e => { if (e.target.closest('.remove-service-btn')) { currentSaleServices.splice(parseInt(e.target.closest('.remove-service-btn').dataset.index), 1); renderCurrentServices(); } });
            saleForm.addEventListener('submit', (e) => { 
                e.preventDefault(); 
                if (currentSaleServices.length === 0) return; 
                const saleData = { 
                    customerName: document.getElementById('customer-name').value, 
                    saleDate: document.getElementById('sale-date').value, 
                    services: currentSaleServices, 
                    totalCommission: currentSaleServices.reduce((sum, s) => sum + s.commission, 0), 
                    notes: document.getElementById('notes').value 
                };
                saveSaleToFirestore(saleData); 
                closeModal(); 
            });
            salesListEl.addEventListener('click', (e) => { 
                const delBtn = e.target.closest('.delete-btn'); 
                if (delBtn) { 
                    const saleId = delBtn.closest('[data-id]').dataset.id; 
                    if(confirm('Are you sure you want to delete this sale?')) {
                        deleteSaleFromFirestore(saleId); 
                    }
                } 
            });
            
            settingsBtn.addEventListener('click', (e) => { 
                e.stopPropagation(); 
                settingsMenu.classList.toggle('hidden');
            });
            document.addEventListener('click', (e) => { if (!settingsMenu.contains(e.target) && !settingsBtn.contains(e.target)) { settingsMenu.classList.add('hidden'); } });
            
            themeToggleBtn.addEventListener('click', toggleTheme);
            tempToggleBtn.addEventListener('click', toggleTempUnit);
        }
        
        // --- Start App ---
        setupEventListeners();
        updateTime();
        setInterval(updateTime, 1000);
        setInterval(updateWeather, 60000);
    </script>
